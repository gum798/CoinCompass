{% extends "base.html" %}

{% block title %}CoinCompass 대시보드 - 실시간 암호화폐 분석{% endblock %}

{% block content %}
<div class="col-12">
    <!-- 제어 패널 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>실시간 모니터링
                        </h5>
                        <div>
                            <button id="start-monitoring" class="btn btn-success me-2">
                                <i class="fas fa-play me-1"></i>시작
                            </button>
                            <button id="stop-monitoring" class="btn btn-danger me-2">
                                <i class="fas fa-stop me-1"></i>중지
                            </button>
                            <button id="refresh-data" class="btn btn-outline-primary">
                                <i class="fas fa-sync-alt me-1"></i>새로고침
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            모니터링 간격: <span id="monitor-interval">{{ settings.interval }}</span>초 | 
                            추적 코인: <span id="monitor-coins">{{ settings.coins|join(', ') }}</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 가격 카드 -->
    <div class="row mb-4" id="price-cards">
        {% for coin in coins %}
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card price-card" id="price-card-{{ coin }}">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-white-50">{{ coin.upper() }}</h6>
                    <div class="metric-value" id="price-{{ coin }}">$0.00</div>
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <div class="metric-label">24시간 변동</div>
                            <div id="change-{{ coin }}" class="fw-bold">0.00%</div>
                        </div>
                        <div>
                            <div class="metric-label">거래량</div>
                            <div id="volume-{{ coin }}" class="fw-bold">$0</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-light btn-sm" onclick="showAnalysis('{{ coin }}')">
                            <i class="fas fa-chart-bar me-1"></i>분석
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 시장 분석 -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>실시간 가격 차트
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>신호 & 알림
                    </h5>
                </div>
                <div class="card-body">
                    <div id="signals-list">
                        <div class="text-muted text-center">
                            실시간 신호를 기다리는 중...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 기술적 분석 -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>기술적 지표
                    </h5>
                </div>
                <div class="card-body">
                    <div id="technical-indicators">
                        {% for coin in coins %}
                        <div class="row mb-3" id="tech-{{ coin }}">
                            <div class="col-4">
                                <strong>{{ coin.upper() }}</strong>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">RSI</div>
                                <div id="rsi-{{ coin }}" class="fw-bold">-</div>
                            </div>
                            <div class="col-4">
                                <div class="metric-label">신호</div>
                                <span id="signal-{{ coin }}" class="badge bg-secondary">HOLD</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>거시경제 지표
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="macro-indicators">
                        <div class="col-6 mb-3">
                            <div class="metric-label">연방기금금리</div>
                            <div id="fed-rate" class="metric-value h4">-</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-label">실업률</div>
                            <div id="unemployment" class="metric-value h4">-</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-label">VIX 지수</div>
                            <div id="vix" class="metric-value h4">-</div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="metric-label">S&P 500</div>
                            <div id="sp500" class="metric-value h4">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 분석 모달 -->
<div class="modal fade" id="analysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i><span id="analysis-coin">코인</span> 상세 분석
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysis-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">분석 중...</span>
                        </div>
                        <div class="mt-2">분석 중...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 차트 변수
    let priceChart = null;
    let priceHistory = {};
    
    // 모니터링 상태
    let isMonitoring = false;
    
    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        initializePriceChart();
        loadInitialData();
        
        // 버튼 이벤트
        document.getElementById('start-monitoring').addEventListener('click', startMonitoring);
        document.getElementById('stop-monitoring').addEventListener('click', stopMonitoring);
        document.getElementById('refresh-data').addEventListener('click', refreshData);
    });
    
    // 가격 차트 초기화
    function initializePriceChart() {
        const ctx = document.getElementById('price-chart').getContext('2d');
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }
    
    // 초기 데이터 로드
    function loadInitialData() {
        fetch('/api/prices?coins={{ coins|join(",") }}')
            .then(response => response.json())
            .then(data => {
                updatePriceCards(data);
            })
            .catch(error => {
                console.error('가격 데이터 로드 오류:', error);
            });
        
        // 거시경제 데이터 로드
        fetch('/api/macro')
            .then(response => response.json())
            .then(data => {
                updateMacroIndicators(data);
            })
            .catch(error => {
                console.error('거시경제 데이터 로드 오류:', error);
            });
    }
    
    // 실시간 데이터 수신
    socket.on('data_update', function(data) {
        updatePriceCards(data.prices);
        updateTechnicalIndicators(data.market_analysis);
        updateMacroIndicators(data.macro_data);
        updatePriceChart(data.prices);
        updateLastUpdateTime(data.timestamp);
    });
    
    // 가격 카드 업데이트
    function updatePriceCards(prices) {
        for (const [coin, data] of Object.entries(prices)) {
            if (data) {
                document.getElementById(`price-${coin}`).textContent = formatPrice(data.price);
                
                const changeElement = document.getElementById(`change-${coin}`);
                changeElement.textContent = formatPercent(data.change_24h);
                changeElement.className = 'fw-bold ' + getPriceChangeClass(data.change_24h);
                
                if (data.volume_24h) {
                    document.getElementById(`volume-${coin}`).textContent = 
                        '$' + (data.volume_24h / 1000000).toFixed(1) + 'M';
                }
            }
        }
    }
    
    // 기술적 지표 업데이트
    function updateTechnicalIndicators(analysis) {
        for (const [coin, data] of Object.entries(analysis)) {
            if (data) {
                const rsiElement = document.getElementById(`rsi-${coin}`);
                if (rsiElement) {
                    rsiElement.textContent = data.rsi ? data.rsi.toFixed(1) : '-';
                }
                
                const signalElement = document.getElementById(`signal-${coin}`);
                if (signalElement) {
                    signalElement.textContent = data.signal || 'HOLD';
                    signalElement.className = 'badge ' + getSignalBadgeClass(data.signal);
                }
            }
        }
    }
    
    // 거시경제 지표 업데이트
    function updateMacroIndicators(macroData) {
        if (macroData) {
            const fedRate = document.getElementById('fed-rate');
            if (fedRate && macroData.fed_rate !== undefined) {
                fedRate.textContent = macroData.fed_rate !== 'N/A' ? macroData.fed_rate + '%' : 'N/A';
            }
            
            const unemployment = document.getElementById('unemployment');
            if (unemployment && macroData.unemployment !== undefined) {
                unemployment.textContent = macroData.unemployment !== 'N/A' ? macroData.unemployment + '%' : 'N/A';
            }
            
            const vix = document.getElementById('vix');
            if (vix && macroData.vix !== undefined) {
                vix.textContent = macroData.vix !== 'N/A' ? macroData.vix.toFixed(1) : 'N/A';
            }
            
            const sp500 = document.getElementById('sp500');
            if (sp500 && macroData.sp500 !== undefined) {
                sp500.textContent = macroData.sp500 !== 'N/A' ? macroData.sp500.toFixed(0) : 'N/A';
            }
        }
    }
    
    // 가격 차트 업데이트
    function updatePriceChart(prices) {
        const now = new Date().toLocaleTimeString('ko-KR');
        
        // 최대 20개 데이터 포인트 유지
        if (priceChart.data.labels.length >= 20) {
            priceChart.data.labels.shift();
            priceChart.data.datasets.forEach(dataset => {
                dataset.data.shift();
            });
        }
        
        priceChart.data.labels.push(now);
        
        // 각 코인별 데이터 업데이트
        const coins = {{ coins|tojsonfilter }};
        const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
        
        coins.forEach((coin, index) => {
            if (prices[coin]) {
                // 데이터셋이 없으면 생성
                if (!priceChart.data.datasets[index]) {
                    priceChart.data.datasets[index] = {
                        label: coin.toUpperCase(),
                        data: [],
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        fill: false,
                        tension: 0.1
                    };
                }
                
                priceChart.data.datasets[index].data.push(prices[coin].price);
            }
        });
        
        priceChart.update('none');
    }
    
    // 신호 배지 클래스
    function getSignalBadgeClass(signal) {
        switch (signal) {
            case 'BUY': return 'bg-success';
            case 'SELL': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    // 모니터링 시작
    function startMonitoring() {
        socket.emit('start_monitoring');
        isMonitoring = true;
        updateMonitoringButtons();
        showAlert('실시간 모니터링을 시작했습니다.', 'success');
    }
    
    // 모니터링 중지
    function stopMonitoring() {
        socket.emit('stop_monitoring');
        isMonitoring = false;
        updateMonitoringButtons();
        showAlert('실시간 모니터링을 중지했습니다.', 'info');
    }
    
    // 데이터 새로고침
    function refreshData() {
        const refreshBtn = document.getElementById('refresh-data');
        const originalHtml = refreshBtn.innerHTML;
        
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>새로고침';
        refreshBtn.disabled = true;
        
        loadInitialData();
        
        setTimeout(() => {
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
            showAlert('데이터를 새로고침했습니다.', 'success');
        }, 1000);
    }
    
    // 모니터링 버튼 상태 업데이트
    function updateMonitoringButtons() {
        const startBtn = document.getElementById('start-monitoring');
        const stopBtn = document.getElementById('stop-monitoring');
        
        if (isMonitoring) {
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else {
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }
    
    // 코인 분석 표시
    function showAnalysis(coin) {
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        document.getElementById('analysis-coin').textContent = coin.toUpperCase();
        
        // 분석 요청
        fetch(`/api/analysis/${coin}`)
            .then(response => response.json())
            .then(data => {
                updateAnalysisModal(data);
            })
            .catch(error => {
                document.getElementById('analysis-content').innerHTML = 
                    '<div class="alert alert-danger">분석 데이터를 불러올 수 없습니다.</div>';
            });
        
        modal.show();
    }
    
    // 분석 모달 업데이트
    function updateAnalysisModal(data) {
        const content = document.getElementById('analysis-content');
        
        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        
        const movement = data.price_movement;
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>가격 정보</h6>
                    <table class="table table-sm">
                        <tr><td>현재가</td><td>${formatPrice(data.price)}</td></tr>
                        <tr><td>24시간 변동</td><td class="${getPriceChangeClass(data.change_24h)}">${formatPercent(data.change_24h)}</td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>투자 추천</h6>
                    <div class="alert alert-info">
                        <strong>${movement.recommendation}</strong><br>
                        <small>신뢰도: ${(movement.confidence * 100).toFixed(0)}%</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h6>변동 분석</h6>
                    <div class="alert alert-light">
                        <strong>변동 유형:</strong> ${movement.type}<br>
                        <strong>요약:</strong> ${movement.summary}
                    </div>
                </div>
            </div>
        `;
    }
    
    // 모니터링 상태 수신
    socket.on('monitoring_status', function(data) {
        isMonitoring = data.status === 'started';
        updateMonitoringButtons();
    });
    
    // 초기 버튼 상태 설정
    updateMonitoringButtons();
</script>
{% endblock %}